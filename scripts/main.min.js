window.Util=function(){"use strict";function e(e,r,t){return console.log("in authenticate!!!!"),r(e.user?function(r){r(e.user)}:function(r){t.currentUser().then(function(t){e.user=t,r(t)},function(t){"no-auth"==t?(e.setStateAfterLogin(),e.$state.go("login")):e.$state.go("error"),r(null)})})}function r(r,t,n){return e(r,t,n).then(function(e){return null==e||e.admin?e:(console.log("unauthorized access"),r.$state.go("error"),null)})}function t(e){return e.line1==i.line1&&e.city==i.city&&e.state==i.state&&e.zip==i.zip}function n(e){return e.line1==s.line1&&e.city==s.city&&e.state==s.state&&e.zip==s.zip}function o(e,r){var t=$("#errorModal");t.find(".modal-body").html(e),t.find(".modal-title").text(r||"Error"),t.modal("show")}function a(e,r,t){var n=document.createElement("a");if(navigator.msSaveBlob)return navigator.msSaveBlob(new Blob([e],{type:r}),t);if("download"in n)return n.href="data:"+r+","+encodeURIComponent(e),n.setAttribute("download",t),document.body.appendChild(n),n.click(),document.body.removeChild(n),!0;var o=document.createElement("iframe");return document.body.appendChild(o),o.src="data:"+r+","+encodeURIComponent(e),setTimeout(function(){document.body.removeChild(o)},333),!0}function u(e){return void 0==e||null==e||""===e}var i={line1:"2695 Creve Coeur Mill Rd",city:"Maryland Heights",state:"MO",zip:63043},s={line1:"4701 State Route 111",city:"Granite City",state:"IL",zip:62040};return{authenticate:["$rootScope","$q","graceGroupsService",e],authenticateAdmin:["$rootScope","$q","graceGroupsService",r],graceWestAddress:i,graceEastAddress:s,isGraceWestCampus:t,isGraceEastCampus:n,alert:o,downloadContent:a,isEmpty:u}}(),angular.module("angularPromiseButtons",[]),angular.module("angularPromiseButtons").directive("promiseBtn",["angularPromiseButtons","$parse","$timeout","$compile",function(e,r,t,n){"use strict";return{restrict:"EA",priority:e.config.priority,scope:{promiseBtn:"=",promiseBtnOptions:"=?"},link:function(o,a,u){function i(e){console.log("in init loading state"),T.btnLoadingClass&&!T.addClassToCurrentBtnOnly&&e.addClass(T.btnLoadingClass),T.disableBtn&&!T.disableCurrentBtnOnly&&e.attr("disabled","disabled")}function s(e){T.minDuration&&!v||!C||(T.btnLoadingClass&&e.removeClass(T.btnLoadingClass),T.disableBtn&&e.removeAttr("disabled"))}function l(e,r){o.$watch(e,function(e){v=!1,C=!1,T.minDuration&&(h=t(function(){v=!0,s(r)},T.minDuration)),e&&e.then?(i(r),e["finally"](function(){C=!0,s(r)})):e&&e.$promise&&(i(r),e.$promise["finally"](function(){C=!0,s(r)}))})}function c(e){return e.split(";").map(function(e){return r(e)})}function d(e){e.append(n(T.spinnerTpl)(o))}function f(e){T.addClassToCurrentBtnOnly&&e.on(T.CLICK_EVENT,function(){e.addClass(T.btnLoadingClass)}),T.disableCurrentBtnOnly&&e.on(T.CLICK_EVENT,function(){e.attr("disabled","disabled")})}function p(e,r,t){o.$evalAsync(function(){var n=c(u[r]);a.unbind(e),a.bind(e,function(){o.$apply(function(){n.forEach(function(r){var n=r(o.$parent,{$event:e});m||(m=l(function(){return n},t))})})})})}function g(e){for(var r=[],t=e.find("button"),n=0;n<t.length;n++){var o=t[n];"submit"===angular.element(o).attr("type")&&r.push(o)}return angular.element(r)}console.log("in link");var m,h,v,C,T=e.config;if(u.promiseBtn)console.log("specific promise"),d(a),f(a),l(function(){return o.promiseBtn},a);else if(console.log("no specific promise"),u.hasOwnProperty(T.CLICK_ATTR))d(a),f(a),p(T.CLICK_EVENT,T.CLICK_ATTR,a);else if(u.hasOwnProperty(T.SUBMIT_ATTR)){var S=g(a);d(S),f(S),p(T.SUBMIT_EVENT,T.SUBMIT_ATTR,S)}o.$watch("promiseBtnOptions",function(e){angular.isObject(e)&&(T=angular.extend({},T,e))},!0),o.$on("$destroy",function(){t.cancel(h)})}}}]),angular.module("angularPromiseButtons").provider("angularPromiseButtons",function(){"use strict";var e={spinnerTpl:'<span class="btn-spinner"></span>',priority:0,disableBtn:!0,btnLoadingClass:"is-loading",addClassToCurrentBtnOnly:!1,disableCurrentBtnOnly:!1,minDuration:!1,CLICK_EVENT:"click",CLICK_ATTR:"ngClick",SUBMIT_EVENT:"submit",SUBMIT_ATTR:"ngSubmit"};return{extendConfig:function(r){e=angular.extend(e,r)},$get:function(){return{config:e}}}}),function(e){"use strict";function r(e,r){var t=this;t.email="",t.password="",t.login=function(){r.login({email:t.email,password:t.password}).then(function(r){e.user=r,e.goToStateAfterLoginOr("users.home")},function(r){e.user=null,"invalid-login"==r?t.invalidLogin=!0:Util.alert("Login failed. Please try again.")})}}function t(e,r,t,n){var o=this;o.logout=function(){e.logout(),r.user=null,t.go("login")},o.isProfilePage=function(){return t.includes("users.home")||t.includes("users.details")&&r.user&&r.user.id==n.id}}function n(e,r,t){function n(e){return void 0!=e&&null!=e&&""!=e.trim()}return e.filter(function(e){var o=!n(r)||e.firstName.toLowerCase().indexOf(r.toLowerCase())>=0,a=!n(t)||e.lastName.toLowerCase().indexOf(t.toLowerCase())>=0;return o&&a})}e.module("grace-groups",["gg.common","groups","graceGroupsService","authorizer"]),e.module("grace-groups-admin",["ngFileUpload","gg.common","ui.router","users","groups","graceGroupsService","authorizer","ngConstants"]).config(["$stateProvider","$urlRouterProvider","partialPath",function(e,t,n){t.otherwise("/users/home"),e.state("login",{url:"/login",templateUrl:n+"/login-form.html",controller:["$rootScope","graceGroupsService",r],controllerAs:"$ctrl"}).state("error",{templateUrl:n+"/error.html"})}]).run(["$rootScope","$state","$stateParams","authorizer",function(e,r,t,n){e.$state=r,e.$stateParams=t,e.authorizer=n,e.$on("$stateChangeError",function(e,t,n,o,a,u){e.preventDefault(),console.log("something went wrong - ",u),r.go("error")}),e.$on("$stateChangeSuccess",function(r,t,n,o,a){var u=$(".navbar-toggle");u.hasClass("collapsed")||u.click(),e.previousState={name:o,params:a}}),e.$on("$stateChangeStart",function(r,t,n){console.log("state change start",t),e.requestedState={name:t.name,params:$.extend({},n)}}),e.setGroupEditReturnToState=function(){e.groupEditReturnToState={name:r.current.name,params:$.extend({},t)}},e.goToGroupEditReturnToState=function(){void 0!=e.groupEditReturnToState?r.go(e.groupEditReturnToState.name,e.groupEditReturnToState.params):r.go("groups.index"),e.groupEditReturnToState=void 0},e.setUserEditReturnToState=function(){e.userEditReturnToState={name:r.current.name,params:$.extend({},t)}},e.goToUserEditReturnToState=function(){void 0!=e.userEditReturnToState?r.go(e.userEditReturnToState.name,e.userEditReturnToState.params):r.go("users.home"),e.userEditReturnToState=void 0},e.setGroupMemberReturnToState=function(){e.groupMemberReturnToState={name:r.current.name,params:$.extend({},t)}},e.goToGroupMemberReturnToState=function(){void 0!=e.groupMemberReturnToState?r.go(e.groupMemberReturnToState.name,e.groupMemberReturnToState.params):r.go("groups.index"),e.groupMemberReturnToState=void 0},e.setStateAfterLogin=function(){e.stateAfterLogin=e.requestedState},e.goToStateAfterLoginOr=function(t){console.log("state after login",e.stateAfterLogin),void 0!=e.stateAfterLogin?(r.go(e.stateAfterLogin.name,e.stateAfterLogin.params),e.stateAfterLogin=void 0):r.go(t)},e.hasError=function(e){return console.log("does it have an error",e.$invalid),!1}}]).component("ggNav",{templateUrl:["partialPath",function(e){return e+"/nav.html"}],controller:["graceGroupsService","$rootScope","$state","$stateParams",t]}).directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,r,t,n){n.$validators.compareTo=function(r){return r==e.otherModelValue},e.$watch("otherModelValue",function(){n.$validate()})}}}).directive("notEqualTo",function(){return{require:"ngModel",scope:{otherModelValue:"=notEqualTo"},link:function(e,r,t,n){n.$validators.notEqualTo=function(r){return void 0==r||""==r?!0:r!=e.otherModelValue},e.$watch("otherModelValue",function(){n.$validate()})}}}).directive("timeAfter",function(){return{require:"ngModel",scope:{otherModelValue:"=timeAfter"},link:function(e,r,t,n){n.$validators.timeAfter=function(r){return null==e.otherModelValue?!0:moment(r).isAfter(moment(e.otherModelValue))},e.$watch("otherModelValue",function(){n.$validate()})}}}).directive("requiredIfNotOther",function(){return{require:"ngModel",scope:{otherModelValue:"=requiredIfNotOther"},link:function(e,r,t,n){n.$validators.requiredIfNotOther=function(r){return!(Util.isEmpty(e.otherModelValue)&&Util.isEmpty(r))},e.$watch("otherModelValue",function(){n.$validate()})}}}).directive("serverValidation",function(){return{require:"ngModel",link:function(e,r,t,n){n.$validators.serverValidation=function(){return!0}}}}).filter("filterByUserName",function(){return n}).filter("hasError",function(){return hasError}).directive("scrollPos",["$state","$window","$timeout","$location","$anchorScroll",function(e,r,t,n,o){var a={};return function(u,i,s){u.$on("$stateChangeStart",function(){"keep"==s.scrollPos&&e.current&&(console.log(e.current.templateUrl),a[e.current.templateUrl]=[r.pageXOffset,r.pageYOffset])}),u.$on("$stateChangeSuccess",function(){if(n.hash())o();else{var u=a[e.current.templateUrl]||[0,0];t(function(){r.scrollTo(u[0],u[1])},0)}})}}])}(window.angular),function(e){"use strict";function r(e,r){var t=r.find(".modal");e.noLabel=e.noLabel||"Cancel",e.yesLabel=e.yesLabel||"Yes",e.modalId=e.modalId||"confirm",e.yesClick=function(){console.log("clicked yes"),t.off("hidden.bs.modal").on("hidden.bs.modal",function(){e.onYes()}),t.modal("hide")},e.noClick=function(){console.log("clicked no"),t.off("hidden.bs.modal").on("hidden.bs.modal",function(){e.onNo()}),t.modal("hide")}}function t(e,r){function t(){e.imageFile=null,e.invalid=null,e.clearImage=!1,e.$apply()}var n=r.find(".modal");n.on("show.bs.modal",t),e.modalId=e.modalId||"image-chooser",e.saveClick=function(){e.clearImage?n.off("hidden.bs.modal").on("hidden.bs.modal",function(){e.onClearImage()}):n.off("hidden.bs.modal").on("hidden.bs.modal",function(){e.onSaveImage({file:e.imageFile})}),n.modal("hide")},e.none=function(){e.clearImage=!0,e.imageFile=null},e.selected=function(){e.clearImage=!1}}function n(e){return"GRACE_HAVE_ROOM"==e?"Grace, room assigned":"GRACE_NEED_ROOM"==e?"Grace, need room":"CHILDCARE_PROVIDED"==e?"Provided":"SINGLES_AND_COUPLES"==e?"Mixed single and married":"MARRIEDS"==e?"Married":"SINGLES"==e?"Single":S(e).humanize().s}e.module("gg.common",["ngConstants","ui.router","users"]).filter("enumToLabel",function(){return n}).filter("leaderMailTo",function(){return function(e,r){return"mailto:"+e.leader.email+"?"+(null!=e.secondaryLeader?"cc="+e.secondaryLeader.email+"&":"")+"subject="+r}}).filter("orDefaultImage",["imagesPath",function(e){return function(r){return Util.isEmpty(r)?e+"/noImage.png":r}}]).directive("confirmBox",["partialPath",function(e){return{restrict:"E",scope:{title:"@",noLabel:"@",yesLabel:"@",onNo:"&",onYes:"&",modalId:"@"},templateUrl:e+"/confirm.html",transclude:!0,link:r}}]).directive("imageChooser",["partialPath",function(e){return{restrict:"E",scope:{title:"@",onClearImage:"&",onSaveImage:"&",modalId:"@",currentImage:"="},templateUrl:e+"/image-chooser.html",link:t}}])}(window.angular),function(e){"use strict";function r(e,r,t,n,o){function a(r){r=r&&r>0?r:1;var t=r*n;u.page=r-1;var o=e.usersByName(u.searchFirstNameText||"",u.searchLastNameText||"",0,t).then(function(e){u.users=e,u.isFiltered=u.searchFirstNameText&&""!=u.searchFirstNameText||u.searchLastNameText&&""!=u.searchLastNameText});return e.countUsersByName(u.searchFirstNameText||"",u.searchLastNameText||"").then(function(e){u.totalCount=e}),o}var u=this;u.users=r,u.totalCount=t,u.isFiltered=!1,u.page=0,o.setUserEditReturnToState(),u.search=function(){return a()},u.showMore=function(){return u.page++,e.usersByName(u.searchFirstNameText||"",u.searchLastNameText||"",u.page,n).then(function(e){Array.prototype.push.apply(u.users,e)})},u.showMoreCount=function(){var e=u.totalCount-u.users.length;return e>n?n:e},u.clearSearch=function(){u.searchFirstNameText="",u.searchLastNameText="",u.search()},u.noUsers=function(){return 0==u.users.length},u.deleteUser=function(r){e.deleteUser(r).then(function(){a(u.page+1)},function(e){console.log(e);var r=[];e.indexOf("user-in-groups-not-deletable")>=0&&r.push("The user is associated to one or more groups."),e.indexOf("user-as-manager-not-deletable")>=0&&(r.push("The user is the manager of one or more users."),Util.alert("The user cannot be deleted because it either contains direct reports or has group associations. Please remove all associations first.")),console.log("can't remove reasons",r),r.length>0?Util.alert(r.join("<br/>"),"The user cannot be deleted"):Util.alert("Failed to delete the user. Please try again later.")})}}function t(e){var r=this;r.deleteIcon=r.deleteIcon||"trash",r.uploadImage=function(t){e.uploadUserImage(r.user.id,t).then(function(e){r.user.imageUrl=e.imageUrl},function(e){e.indexOf("invalid-image-file")>=0?Util.alert("Could not save the image. Invalid file type.","Invalid image"):Util.alert("Failed to save the image. Please try again later.")})},r.clearImage=function(){var t=r.user.imageUrl;r.user.imageUrl=null,e.updateUser(r.user).then(null,function(e){console.log(e),r.user.imageUrl=t,Util.alert("Failed to clear the image for this user. Please try again later.")})}}function n(e,r,t){function n(e,r){var t=!1;r.forEach&&r.forEach(function(r){"user-email-not-unique"==r&&(e.uEmail.$error.serverValidation=!0,e.uEmail.$error.serverError="already used",t=!0),"user-role-reduction-conflict"==r&&(e.uRole.$error.serverValidation=!0,e.uRole.$error.serverError="This role is not applicable for current direct reports.",t=!0)}),t?Util.alert("Please correct errors indicated in red.","Info"):Util.alert("Failed to save the user. Please try again later.")}var o=this;o.managers=o.managers||[],o.availableManagers=[],o.roles=t.rolesAssignableBy(e.user,e.user.id==o.user.id),1==o.roles.length&&(o.user.role=o.roles[0].code),o.noPreviousPassword="CONTACT"==o.user.role,o.handleRoleChange=function(){"ADMIN"!=o.user.role&&"PASTOR"!=o.user.role||(o.user.admin=!0),o.determineAvailableManagers()},o.determineAvailableManagers=function(){var e=[];switch(o.user.role){case"CONTACT":case"GROUP_LEADER":e.push("DIVISION_LEADER");case"DIVISION_LEADER":e.push("DIVISION_DIRECTOR");case"DIVISION_DIRECTOR":e.push("PASTOR")}o.availableManagers=o.managers.filter(function(r){return e.indexOf(r.role)>=0&&r.id!=o.user.id}),0==o.availableManagers.filter(function(e){return e.id==o.user.managerId}).length&&(o.user.managerId=null)},o.determineAvailableManagers(),o.isNew=null==o.user.id||void 0==o.user.id,(o.isNew||o.startWithChangePassword)&&"CONTACT"!=o.user.role&&(o.changePassword=!0),o.needsManager=function(){return"PASTOR"!=o.user.role&&"CONTACT"!=o.user.role&&"ADMIN"!=o.user.role},o.save=function(e){if(e.$valid)return null==o.user.id?r.createUser(o.user).then(function(e){o.user.id=e.id,o.onSave()},function(r){n(e,r)}):r.updateUser(o.user).then(o.onSave,function(r){n(e,r)});var t=$(".has-error:first");return t.length>0&&$("html, body").animate({scrollTop:t.offset().top},500),Util.alert("Please correct errors indicated in red.","Info"),null}}function o(e,r,t,n,o){var a=this;a.changePassword=o,a.user=e,a.managers=r,a.cancel=function(){t.goToUserEditReturnToState()},a.afterSave=function(){a.isRootUser()&&null!=a.user.newPassword&&""!=a.user.newPassword?n.login({email:a.user.email,password:a.user.newPassword}).then(function(e){t.user=e,t.goToUserEditReturnToState()},function(){t.user=null,t.$state.go("login")}):t.goToUserEditReturnToState()},a.isRootUser=function(){return a.user.id==t.user.id}}function a(e,r,t,n,o,a){var u=this;u.user=e,u.groups=t,u.directReports=n,o.setUserEditReturnToState(),o.setGroupEditReturnToState(),o.setGroupMemberReturnToState(),u.isRootUser=function(){return u.user.id==r.id},u.deleteGroup=function(e){a.deleteGroup(e).then(function(){u.groups.splice(u.groups.indexOf(e),1)})}}function u(e){var r=this;r.user={},r.managers=e}e.module("users",["ui.router","angularPromiseButtons","ngConstants"]).config(["$stateProvider","partialPath",function(e,t){e.state("users",{url:"/users","abstract":!0,template:"<ui-view></ui-view>",resolve:{authUser:Util.authenticate}}).state("users.index",{url:"",templateUrl:t+"/users/index.html",resolve:{limit:function(){return 10},users:["graceGroupsService","limit",function(e,r){return e.usersByName("","",0,r)}],totalCount:["graceGroupsService",function(e){return e.countUsersByName("","")}]},controller:["graceGroupsService","users","totalCount","limit","$rootScope",r],controllerAs:"$ctrl"}).state("users.edit",{url:"/{id:int}/edit",templateUrl:t+"/users/edit.html",resolve:{user:["graceGroupsService","$stateParams","authUser",function(e,r){return e.user(r.id)}],managers:["graceGroupsService","authUser",function(e){return e.managers()}]},controller:["user","managers","$rootScope","graceGroupsService",o],controllerAs:"$ctrl"}).state("users.editAndChangePassword",{url:"/{id:int}/editAndChangePassword",templateUrl:t+"/users/edit.html",resolve:{user:["graceGroupsService","$stateParams","authUser",function(e,r){return e.user(r.id)}],managers:["graceGroupsService","authUser",function(e){return e.managers()}],changePassword:function(){return!0}},controller:["user","managers","$rootScope","graceGroupsService","changePassword",o],controllerAs:"$ctrl"}).state("users.details",{url:"/{id:int}/details",templateUrl:t+"/users/details.html",resolve:{user:["graceGroupsService","$stateParams",function(e,r){return e.user(r.id)}],groups:["graceGroupsService","$stateParams",function(e,r){return e.groupsForUser(r.id)}],directReports:["graceGroupsService","$stateParams",function(e,r){return e.directReports(r.id)}]},controller:["user","authUser","groups","directReports","$rootScope","graceGroupsService",a],controllerAs:"$ctrl"}).state("users.home",{url:"/home",templateUrl:t+"/users/details.html",resolve:{user:["graceGroupsService","authUser",function(e,r){return e.user(r.id)}],groups:["graceGroupsService","authUser",function(e,r){return e.groupsForUser(r.id)}],directReports:["graceGroupsService","authUser",function(e,r){return e.directReports(r.id)}]},controller:["user","authUser","groups","directReports","$rootScope","graceGroupsService",a],controllerAs:"$ctrl"}).state("users.new",{url:"/new",templateUrl:t+"/users/new.html",resolve:{managers:["graceGroupsService",function(e){return e.managers()}]},controller:["managers",u],controllerAs:"$ctrl"})}]).component("ggUser",{templateUrl:["partialPath",function(e){return e+"/users/view.html"}],bindings:{user:"<",hideRole:"@",onEdit:"&",showEdit:"<",onSelect:"&",showSelect:"<",onRemove:"&",showRemove:"<",confirmRemove:"<",badge:"<",deleteIcon:"@",highlight:"@"},controller:["graceGroupsService",t]}).component("ggUserForm",{templateUrl:["partialPath",function(e){return e+"/users/userForm.html"}],bindings:{user:"<",onSave:"&",onCancel:"&",noRoleChange:"@",managers:"<",startWithChangePassword:"<"},controller:["$rootScope","graceGroupsService","authorizer",n]})}(window.angular),function(e){"use strict";function r(e,r){var t=this;e.setGroupEditReturnToState(),e.setGroupMemberReturnToState(),t.download=function(){r.groupExport().then(function(e){Util.downloadContent(e,"text/csv","groups.csv")},function(){Util.alert("Failed to download the groups. Please try again later.")})}}function t(e,r,t){function n(e){return o.options&&o.options.split(" ").includes(e)}var o=this;o.leaderDisplay=function(){return f(o.group)},o.scheduleDisplay=function(){return p(o.group.schedule)},o.timeDisplay=function(){return m(o.group.schedule)},o.ageDisplay=function(){return h(o.group)},o.onGraceWestCampus=function(){return Util.isGraceWestCampus(o.group.address)},o.onGraceEastCampus=function(){return Util.isGraceEastCampus(o.group.address)},o.showEdit=function(){return n("edit")},o.showDelete=function(){return n("delete")},o.downloadCalendar=function(){var t=null==r.user?e.publishedGroupCalendarExport:e.groupCalendarExport;t.call(this,o.group.id).then(function(e){Util.downloadContent(e,"text/calendar","group-calendar.ics")},function(){Util.alert("Failed to download the group calendar. Please try again later.")})},o.$onInit=function(){t.find('[data-toggle="tooltip"]').tooltip({trigger:"hover"})},o.showStreetAddress=function(){return r.user||o.onGraceWestCampus()||o.onGraceEastCampus()}}function n(e,r){function t(e){e=e&&e>0?e:1,a.searchCriteria.limit=e*a.resultLimit,a.searchCriteria.page=0,a.searchCriteria.startTimeDate?a.searchCriteria.startTime=moment(a.searchCriteria.startTimeDate).format("HH:mm"):delete a.searchCriteria.startTime,"ALL"==a.ageType&&delete a.searchCriteria.age,a.loading=!0;var r=a.groups=u.call(this,a.searchCriteria).then(function(r){a.groups=r,a.isFiltered=n(a.searchCriteria),a.searchCriteria.page=e-1,a.loading=!1});return i.call(this,a.searchCriteria).then(function(e){a.totalCount=e}),a.showCriteria&&(a.showCriteria=!1,$("#search-container").collapse("hide")),r}function n(e){for(var r=["category","keyWord","dayOfWeek","startTimeDate","gender","status","age","childCare","onCampus"],t=0;t<r.length;t++)if(e[r[t]]&&""!=e[r[t]])return!0;return!1}function o(){a.searchCriteria={limit:a.resultLimit,page:0},a.ageType="ALL"}console.log("in listing controller");var a=this,u=r.user?e.groupSearch:e.publishedGroupSearch,i=r.user?e.groupCount:e.publishedGroupCount;a.resultLimit=a.limit||10,a.showCriteria=!1,a.isFiltered=!1,o(),a.search=function(){return t()},a.showMore=function(){return a.searchCriteria.page++,u.call(this,a.searchCriteria).then(function(e){Array.prototype.push.apply(a.groups,e)})},a.showMoreCount=function(){if(a.groups&&a.totalCount){var e=a.totalCount-a.groups.length;return e>a.resultLimit?a.resultLimit:e}return 0},a.clear=function(){o(),a.search()},a.deleteGroup=function(r){e.deleteGroup(r).then(function(){t(a.searchCriteria.page+1)},function(){Util.alert("Failed to delete the group. Please try again later.")})},this.$onInit=function(){a.search()}}function o(){function e(){n.group.schedule.startTimeDate&&(n.group.schedule.startTime=moment(n.group.schedule.startTimeDate).format("HH:mm")),n.group.schedule.endTimeDate&&(n.group.schedule.endTime=moment(n.group.schedule.endTimeDate).format("HH:mm")),n.group.schedule.startDateDate&&(n.group.schedule.startDate=moment(n.group.schedule.startDateDate).format("YYYY-MM-DD")),n.group.schedule.endDateDate&&(n.group.schedule.endDate=moment(n.group.schedule.endDateDate).format("YYYY-MM-DD"))}function r(e){return"WEDNESDAY"==e.schedule.dayOfWeek&&("WEEKLY"==e.schedule.frequency||"EVERY_TWO_WEEKS"==e.schedule.frequency||"BI_MONTHLY_FIRST_THIRD"==e.schedule.frequency||"TRI_MONTHLY"==e.schedule.frequency||"MONTHLY_FIRST"==e.schedule.frequency)&&e.schedule.startTime&&e.schedule.endTime&&moment("2016-10-12T"+e.schedule.startTime).isBefore(moment("2016-10-12T20:00"))&&moment("2016-10-12T"+e.schedule.endTime).isAfter(moment("2016-10-12T19:00"))}function t(e){return"OTHER"!=e.locationType&&moment("2016-10-13T"+e.schedule.endTime).isAfter(moment("2016-10-13T23:00"))}var n=this;n.group.address||(n.group.address={}),n.group.schedule||(n.group.schedule={}),n.group.roomRequest||(n.group.roomRequest={}),n.group.schedule.startTime&&(n.group.schedule.startTimeDate=moment(n.group.schedule.startTime,"HH:mm").toDate()),n.group.schedule.endTime&&(n.group.schedule.endTimeDate=moment(n.group.schedule.endTime,"HH:mm").toDate()),n.group.schedule.startDate&&(n.group.schedule.startDateDate=moment(n.group.schedule.startDate,"YYYY-MM-DD").toDate()),n.group.schedule.endDate&&(n.group.schedule.endDateDate=moment(n.group.schedule.endDate,"YYYY-MM-DD").toDate()),n.locationOnCampus=function(){return"GRACE_NEED_ROOM"==n.group.locationType||"GRACE_HAVE_ROOM"==n.group.locationType},n.requireScheduleTime=function(){return n.group&&"AS_NEEDED"!=n.group.schedule.frequency},n.charactersRemaining=function(e,r){return e-r.length},n.save=function(o){if(o.$valid)if("GRACE_NEED_ROOM"==n.group.locationType&&(n.group.address.room=null),e(),t(n.group))Util.alert("Sorry, the church is closed for meetings after 11pm. Please adjust your schedule.","Info"),$("html, body").animate({scrollTop:$("#schedule").offset().top},500);else{if(!r(n.group))return n.group.study&&(n.group.study=n.group.study.replace(/\n+/g," ")),n.onSave(n.group);Util.alert("Sorry, group meetings cannot occur at the same time as the communion service on first Wednesdays from 7pm to 8pm. Please adjust your schedule.","Info"),$("html, body").animate({scrollTop:$("#schedule").offset().top},500)}else{var a=$(".has-error:first");a.length>0&&$("html, body").animate({scrollTop:a.offset().top},500),Util.alert("Please correct errors indicated in red.","Info")}return null}}function a(e,r,t,n){var o=this;o.group=t,o.leaders=n,o.updateGroup=function(){return r.updateGroup(o.group).then(function(){e.goToGroupEditReturnToState()},function(e){console.log("failed to update the group: "+e),Util.alert("Failed to save the group information. Please try again later.")})}}function u(e,r,t,n){var o=this;o.group={},o.leaders=t,e.authorizer.userCanCreateGroup(n)?"GROUP_LEADER"==n.role&&(o.group.leaderId=n.id):(console.log("unauthorized access"),e.$state.go("error")),o.createGroup=function(){return r.createGroup(o.group).then(function(){e.goToGroupEditReturnToState()},function(e){console.log("failed to create the group: "+e),Util.alert("Failed to create the group. Please try again later.")})}}function i(e,r,t,n){var o=this;o.group=r,o.members=t,o.removeMember=function(r){e.removeGroupMember(o.group.id,r.id).then(function(){o.members.splice(o.members.indexOf(r),1)},function(){console.log("failed to remove the member - ",err),Util.alert("Failed to remove the member. Please try again later.")})},o.backToLabel=function(){return!n.groupMemberReturnToState||"users.details"!=n.groupMemberReturnToState.name&&"users.home"!=n.groupMemberReturnToState.name?"groups":"user details"}}function s(e,r,t,n,o){function a(e,r){var t=!1;r.forEach&&r.forEach(function(r){"user-email-not-unique"==r&&(e.uEmail.$error.serverValidation=!0,e.uEmail.$error.serverError="already used",t=!0)}),t?Util.alert("Please correct errors indicated in red.","Info"):Util.alert("Failed to save the user. Please try again later.")}var u=this;u.newContact={role:"CONTACT"},u.users=[],u.totalCount=null,u.pageCount=0,u.group=t,u.nameChanged=function(){""==(u.newContact.firstName||"")&&""==(u.newContact.lastName||"")?(u.users=[],u.totalCount=null,u.pageCount=0):(r.usersByName(u.newContact.firstName||"",u.newContact.lastName||"",0,o).then(function(e){u.users=e,u.pageCount=1}),r.countUsersByName(u.newContact.firstName||"",u.newContact.lastName||"").then(function(e){u.totalCount=e}))},u.setCreateMode=function(e){u.createMode=e},u.showMore=function(){r.usersByName(u.newContact.firstName||"",u.newContact.lastName||"",u.pageCount++,o).then(function(e){Array.prototype.push.apply(u.users,e)})},u.showMoreCount=function(){var e=u.totalCount-u.users.length;return e>o?o:e},u.isMember=function(e){for(var r=0;r<n.length;r++){var t=n[r];if(t.id==e.id)return!0;if(t.lastName.toLocaleLowerCase()>e.lastName.toLocaleLowerCase())return!1}return!1},u.addMember=function(o){r.addGroupMember(u.group.id,o.id).then(function(){n.push(o),n.sort(d),e.go("groups.members.view",{id:t.id})},function(e){console.log("failed to add the member - ",e),Util.alert("Failed to add the member. Please try again later.")})},u.saveAndAddMember=function(e){e.$valid?r.createUser(u.newContact).then(function(e){u.newContact.id=e.id,u.addMember(e)},function(r){a(e,r)}):Util.alert("Please correct errors indicated in red.","Info")}}function l(e){var r=this;r.groups=e,r.leaderDisplay=f,r.scheduleDisplay=p,r.timeDisplay=m}function c(e,r,t){var n=this;n.group=e,n.leaderDisplay=f,n.scheduleDisplay=p,n.timeDisplay=m,n.ageDisplay=h,n.approve=function(e){if(e.$valid)return r.approveGroup(n.group).then(function(){t.go("approvals.index")},function(e){console.log("failed to approve the group - ",e),Util.alert("Failed to approve the group. Please try again later.")});var o=$(".has-error:first");return o.length>0&&$("html, body").animate({scrollTop:o.offset().top},500),Util.alert("Please correct errors indicated in red.","Info"),null}}function d(e,r){return e.lastName.localeCompare(r.lastName)}function f(e){var r=e.leader.fullName();return e.secondaryLeader&&(r=r+" & "+e.secondaryLeader.fullName()),r}function p(e){if(null==e)return"";switch(e.frequency){case"WEEKLY":return"Every "+g(e);case"EVERY_TWO_WEEKS":return"Every other "+g(e);case"BI_MONTHLY_FIRST_THIRD":return"Every 1st and 3rd "+g(e);case"BI_MONTHLY_SECOND_FOURTH":return"Every 2nd and 4th "+g(e);case"TRI_MONTHLY":return"Every 1st, 3rd, and 5th "+g(e);case"MONTHLY_FIRST":return"Every 1st "+g(e);case"MONTHLY_SECOND":return"Every 2nd "+g(e);case"MONTHLY_THIRD":return"Every 3rd "+g(e);case"MONTHLY_FOURTH":return"Every 4th "+g(e);case"AS_NEEDED":return g(e)+", as needed"}}function g(e){return S(e.dayOfWeek).capitalize().s}function m(e){return null==e?"":moment(e.startTime,"HH:mm").format("h:mma")+" to "+moment(e.endTime,"HH:mm").format("h:mma")}function h(e){if(e.studentMinistry)return"students";var r=e.minAge||18;return 18>=r&&null==e.maxAge?"all adults":null==e.maxAge?r+" and older":r+" to "+e.maxAge}e.module("groups",["ui.router","users","ngConstants"]).config(["$stateProvider","partialPath",function(e,t){console.log("in config"),e.state("groups",{url:"/groups","abstract":!0,template:"<ui-view></ui-view>",resolve:{authUser:Util.authenticate}}).state("groups.index",{url:"",templateUrl:t+"/groups/index.html",controller:["$rootScope","graceGroupsService",r],controllerAs:"$ctrl"}).state("groups.edit",{url:"/{id:int}/edit",templateUrl:t+"/groups/edit.html",resolve:{group:["graceGroupsService","$stateParams",function(e,r){return e.group(r.id)}],leaders:["graceGroupsService","authUser",function(e,r){return e.groupLeadersForUser(r)}]},controller:["$rootScope","graceGroupsService","group","leaders",a],controllerAs:"$ctrl"}).state("groups.new",{url:"/new",templateUrl:t+"/groups/new.html",resolve:{leaders:["graceGroupsService","authUser",function(e,r){return e.groupLeadersForUser(r)}]},controller:["$rootScope","graceGroupsService","leaders","authUser",u],controllerAs:"$ctrl"}).state("groups.members",{url:"/{id:int}/members","abstract":!0,template:"<ui-view></ui-view>",resolve:{group:["graceGroupsService","$stateParams",function(e,r){return e.group(r.id)}],members:["graceGroupsService","$stateParams",function(e,r){return e.groupMembers(r.id).then(function(e){return e.sort(d)})}]}}).state("groups.members.view",{url:"",templateUrl:t+"/groups/members.html",controller:["graceGroupsService","group","members","$rootScope",i],controllerAs:"$ctrl"}).state("groups.members.select",{url:"/select",templateUrl:t+"/groups/member-select.html",resolve:{limit:function(){return 5}},controller:["$state","graceGroupsService","group","members","limit",s],controllerAs:"$ctrl"}).state("approvals",{url:"/approvals","abstract":!0,template:"<ui-view></ui-view>",resolve:{authUser:Util.authenticateAdmin}}).state("approvals.index",{url:"",templateUrl:t+"/approvals/index.html",resolve:{groups:["graceGroupsService",function(e){return e.groupsPendingApproval()}]},controller:["groups",l],controllerAs:"$ctrl"}).state("approvals.review",{url:"/{id:int}/review",templateUrl:t+"/approvals/review.html",resolve:{group:["graceGroupsService","$stateParams",function(e,r){return e.group(r.id)}]},controller:["group","graceGroupsService","$state",c],controllerAs:"$ctrl"})}]).component("ggGroup",{templateUrl:["partialPath",function(e){return e+"/groups/view.html"}],bindings:{$router:"<",group:"<",options:"@",onEdit:"&",onMembers:"&",onDelete:"&"},controller:["graceGroupsService","$rootScope","$element",t]}).component("graceGroupListing",{templateUrl:["partialPath",function(e){return e+"/groups/listing.html"}],bindings:{limit:"<",showSearch:"<",onEditGroup:"&",onGroupMembers:"&"},controller:["graceGroupsService","$rootScope",n]}).component("ggGroupForm",{templateUrl:["partialPath",function(e){return e+"/groups/groupForm.html"}],bindings:{$router:"<",group:"<",
leaders:"<",onSave:"&",onCancel:"&"},controller:[o]})}(window.angular),function(e){"use strict";function r(e,r,t,n,o,a){function u(o){return r(function(r,a){e.post(F("/users/login"),o,H()).then(function(e){t.put(z,e.data.token,{secure:n}),V(e.data.user),r(e.data.user)},function(e){var r=e.status<500&&e.status>399?"invalid-login":"server-error";a(r)})})}function i(){return r(function(r,t){e.get(F("/users/current"),H()).then(function(e){V(e.data),r(e.data)},function(e){console.log("current user error",e);var r=401==e.status?"no-auth":"server-error";t(r)})})}function s(){t.remove(z)}function l(t){return r(function(r,n){e.put(F("/users",t.id),t,H()).then(function(){r()},function(e){n(q(e))})})}function c(t){return r(function(r,n){e.post(F("/users"),t,H()).then(function(e){V(e.data),r(e.data)},function(e){n(q(e))})})}function d(){return r(function(r,t){e.get(F("/users"),H()).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(){t("server-error")})})}function f(t){return r(function(r,n){e.get(F("/users",t),H()).then(function(e){V(e.data),r(e.data)},function(e){var r=e.status<500?"user-not-found":"server-error";n(r)})})}function p(t){return r(function(r,n){e.get(F("/users/by-role"),H({role:t})).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(e){console.log(e),n("server-error")})})}function g(t,n,o,a){return r(function(r,u){e.get(F("/users/by-name"),H({firstName:t,lastName:n,page:o,limit:a})).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(){u("server-error")})})}function m(t,n){return r(function(r,o){e.get(F("/users/count/by-name"),H({firstName:t,lastName:n})).then(function(e){r(e.data)},function(){o("server-error")})})}function h(t){return r(function(r,n){e.get(F("/users",t.id,"group-leaders"),H()).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(){n("server-error")})})}function v(){return r(function(r,t){e.get(F("/users/managers"),H()).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(){t("server-error")})})}function C(t){return r(function(r,n){e.get(F("/users",t,"direct-reports"),H()).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(){n("server-error")})})}function T(t){return r(function(r,n){e["delete"](F("/users",t.id),H()).then(function(){r()},function(e){n(q(e))})})}function E(e,n){var o=t.get(z);return r(function(r,t){a.upload({url:F("/users",e,"image"),data:{file:n},headers:{Authorization:"Bearer "+o},method:"POST"}).then(function(e){console.log(e.data),V(e.data),r(e.data)},function(e){t(q(e))})})}function b(){return r(function(r,t){e.get(F("/groups"),H()).then(function(e){e.data.forEach(function(e){Y(e)}),r(e.data)},function(){t("server-error")})})}function y(){return r(function(r,t){e.get(F("/groups/export"),H()).then(function(e){r(e.data)},function(){t("server-error")})})}function U(){return r(function(r,t){e.get(F("/groups/pending-approval"),H()).then(function(e){e.data.forEach(function(e){Y(e)}),r(e.data)},function(){t("server-error")})})}function $(t){return r(function(r,n){e.post(F("/groups"),t,H()).then(function(){r()},function(e){n(q(e))})})}function R(t){return r(function(r,n){e.get(F("/groups",t),H()).then(function(e){Y(e.data),r(e.data)},function(e){var r=e.status<500?"group-not-found":"server-error";n(r)})})}function w(t){return r(function(r,n){e.put(F("/groups",t.id),t,H()).then(function(){r()},function(e){n(q(e))})})}function G(t){return r(function(r,n){e.get(F("/groups",t,"members"),H()).then(function(e){e.data.forEach(function(e){V(e)}),r(e.data)},function(e){var r=e.status<500?"group-not-found":"server-error";n(r)})})}function A(t,n){return r(function(r,o){e.put(F("/groups",t,"add-member/"+n),null,H()).then(function(){r()},function(e){var r=e.status<500?"bad-data":"server-error";o(r)})})}function N(t,n){return r(function(r,o){e.put(F("/groups",t,"remove-member/"+n),null,H()).then(function(){r()},function(e){var r=e.status<500?"bad-data":"server-error";o(r)})})}function D(t){return r(function(r,n){e.put(F("/groups",t.id,"approve"),t,H()).then(function(){r()},function(){n("server-error")})})}function I(t){return r(function(r,n){e.get(F("/groups/by-user"),H({userId:t})).then(function(e){e.data.forEach(function(e){Y(e)}),r(e.data)},function(){n("server-error")})})}function M(t){return r(function(r,n){e.get(F("/groups/search"),H(t)).then(function(e){console.log(e),e.data.forEach(function(e){Y(e)}),r(e.data)},function(){n("server-error")})})}function P(t){return r(function(r,n){e.get(F("/groups/count"),H(t)).then(function(e){r(e.data)},function(){n("server-error")})})}function L(t){return r(function(r,n){e.get(F("/groups/published/search"),H(t)).then(function(e){console.log(e),e.data.forEach(function(e){Y(e)}),r(e.data)},function(){n("server-error")})})}function O(t){return r(function(r,n){e.get(F("/groups/published/count"),H(t)).then(function(e){r(e.data)},function(){n("server-error")})})}function _(t){return r(function(r,n){e["delete"](F("/groups",t.id),H()).then(function(){r()},function(e){n(q(e))})})}function x(t){return r(function(r,n){e.get(F("/groups",t,"calendar-export"),H()).then(function(e){r(e.data)},function(){n("server-error")})})}function B(t){return r(function(r,n){e.get(F("/groups",t,"published/calendar-export"),H()).then(function(e){r(e.data)},function(){n("server-error")})})}function F(e,r,t){var n=k+e;return r&&(n=n+"/"+r),t&&(n=n+"/"+t),n}function H(e){var r={withCredentials:!0};e&&(r.params=e);var n=t.get(z);return n&&(r.headers={Authorization:"Bearer "+n}),r}function V(e){e.shortName=function(){return S(e.firstName).capitalize().s+" "+S(e.lastName.substring(0,1)).capitalize()+"."},e.fullName=function(){return S(e.firstName).capitalize().s+" "+S(e.lastName).capitalize().s},e.roleLabel=function(){return S(e.role).humanize().s}}function Y(e){V(e.leader),e.secondaryLeader&&V(e.secondaryLeader),e.isFull=function(){return null!=this.capacity&&this.memberIds.length>=this.capacity}}function q(e){return e.status<500&&e.status>399?e.data:["server-error"]}var k=o,z="ggs-auth-token";return{login:u,currentUser:i,logout:s,updateUser:l,users:d,user:f,createUser:c,usersByRole:p,usersByName:g,countUsersByName:m,groupLeadersForUser:h,managers:v,directReports:C,deleteUser:T,uploadUserImage:E,groups:b,groupExport:y,groupsPendingApproval:U,createGroup:$,group:R,updateGroup:w,groupMembers:G,addGroupMember:A,removeGroupMember:N,approveGroup:D,groupsForUser:I,groupSearch:M,groupCount:P,publishedGroupSearch:L,publishedGroupCount:O,deleteGroup:_,groupCalendarExport:x,publishedGroupCalendarExport:B}}e.module("graceGroupsService",["ngCookies","ngConstants","ngFileUpload"]).config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).service("graceGroupsService",["$http","$q","$cookies","secureCookies","serviceUrl","Upload",r])}(window.angular),function(e){"use strict";function r(){function e(){return g.slice()}function r(e,r){if(r=r||!1,"PASTOR"==e.role||e.admin)return g.slice();for(var t=0;t<g.length-1;t++)if(g[t].code==e.role)return g.slice(r?t:t+1);return[{code:"CONTACT",label:"Contact"}]}function t(e,r){return null==e?!1:e.admin||"PASTOR"==e.role||"CONTACT"==r.role||e.id==r.id?!0:s(e,r)}function n(e,r){return null==e?!1:"CONTACT"==r.role?p(e):e.id!=r.id&&t(e,r)}function o(e,r){return null==e?!1:e.admin||null==r.id||null==r.manager||t(e,r)&&e.id!=r.id}function a(e){return null==e?!1:e.admin||"GROUP_LEADER"!=e.role&&"CONTACT"!=e.role}function u(e,r){if(null==e)return!1;var t=e.admin||"PASTOR"==e.role,n=e.id==r.leaderId,o=e.id==r.secondaryLeaderId,a=s(e,r.leader);return t||n||o||a}function i(e){return null!=e}function s(e,r){for(var t=r.manager,n=0;null!=t&&n++<g.length-1;){if(t.id==e.id)return!0;t=t.manager}return!1}function l(e,r){return u(e,r)}function c(e,r){var t=[];return u(e,r)&&t.push("edit"),l(e,r)&&t.push("delete"),t}function d(e,r){return c(e,r).join(" ")}function f(e){return p(e)}function p(e){return e&&(e.admin||"PASTOR"==e.role)}var g=[{code:"ADMIN",label:"Admin"},{code:"PASTOR",label:"Pastor"},{code:"DIVISION_DIRECTOR",label:"Division Director"},{code:"DIVISION_LEADER",label:"Division Leader"},{code:"GROUP_LEADER",label:"Group Leader"},{code:"CONTACT",label:"Contact"}];return{roles:e,rolesAssignableBy:r,userCanEditUser:t,userCanDeleteUser:n,userCanChangeManagerOf:o,userCanChangeGroupLeader:a,userCanEditGroup:u,userCanCreateGroup:i,isUserManagerOf:s,userCanDeleteGroup:l,groupPrivileges:c,groupPrivilegesString:d,canDownloadGroups:f}}e.module("authorizer",[]).service("authorizer",[r])}(window.angular);